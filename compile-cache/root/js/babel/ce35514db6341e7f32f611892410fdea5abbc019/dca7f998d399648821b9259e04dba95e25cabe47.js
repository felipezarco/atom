Object.defineProperty(exports, '__esModule', {
  value: true
});

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { 'default': obj }; }

var _atom = require('atom');

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _client = require('./client');

var _client2 = _interopRequireDefault(_client);

var _viewsTreeView = require('./views/tree-view');

var _viewsTreeView2 = _interopRequireDefault(_viewsTreeView);

var _viewsStatusBar = require('./views/status-bar');

var _viewsStatusBar2 = _interopRequireDefault(_viewsStatusBar);

var _helpers = require('./helpers');

var _menusMain = require('./menus/main');

var _menusMain2 = _interopRequireDefault(_menusMain);

var _configSchemaJson = require('./config-schema.json');

var _configSchemaJson2 = _interopRequireDefault(_configSchemaJson);

var _remoteStorage = require('./remote-storage');

var _remoteStorage2 = _interopRequireDefault(_remoteStorage);

'use babel';

exports['default'] = {

  config: _configSchemaJson2['default'],
  client: null,
  coreTreeView: null,
  treeView: null,
  statusBarTile: null,
  statusBarView: null,
  subscriptions: null,

  activate: function activate(state) {
    var _this = this;

    this.storage = new _remoteStorage2['default'](state);

    if (this.subscriptions) {
      this.deactivate();
    }

    this.config = _configSchemaJson2['default'];
    this.client = new _client2['default']();
    atom.project.remoteftpMain = this; // change remoteftp to object containing client and main?
    atom.project.remoteftp = this.client;
    this.treeView = new _viewsTreeView2['default'](this.storage);

    this.subscriptions = new _atom.CompositeDisposable();
    this.subscriptions.add(atom.workspace.observeTextEditors(function (editor) {
      _this.subscriptions.add(editor.onDidSave(function (event) {
        return _this.fileSaved(event);
      }));
    }), atom.project.onDidChangePaths(function () {
      if (!(0, _helpers.hasProject)() || !_this.client.isConnected()) return;

      atom.commands.dispatch(atom.views.getView(atom.workspace), 'remote-ftp:disconnect');
      atom.commands.dispatch(atom.views.getView(atom.workspace), 'remote-ftp:connect');
    }), atom.workspace.paneContainers.left.onDidChangeActivePaneItem(function (activeItem) {
      if (_this.treeView !== activeItem) return;

      _this.storage.data.options.treeViewSide = 'left';
    }), atom.workspace.paneContainers.right.onDidChangeActivePaneItem(function (activeItem) {
      if (_this.treeView !== activeItem) return;

      _this.storage.data.options.treeViewSide = 'right';
    }), atom.workspace.paneContainers.bottom.onDidChangeActivePaneItem(function (activeItem) {
      if (_this.treeView !== activeItem) return;

      _this.storage.data.options.treeViewSide = 'bottom';
    }), atom.config.onDidChange('remote-ftp.tree.enableDragAndDrop', function (value) {
      if (value.newValue) {
        _this.createTreeViewEvents();
      } else {
        _this.dropTreeViewEvents();
      }
    }));

    if (atom.config.get('remote-ftp.tree.enableDragAndDrop')) {
      this.createTreeViewEvents();
    }

    this.client.onDidConnected(function () {
      _this.treeView.root.name.attr('data-name', _path2['default'].basename(_this.client.root.remote));
      _this.treeView.root.name.attr('data-path', _this.client.root.remote);

      // .ftpignore initialize
      _this.client.updateIgnore();
    });

    // NOTE: if there is a project folder & show view on startup
    //  is true, show the Remote FTP sidebar
    if ((0, _helpers.hasProject)()) {
      // NOTE: setTimeout is for when multiple hosts option is true
      setTimeout(function () {
        var conf = new _atom.File(_this.client.getConfigPath());

        conf.exists().then(function (exists) {
          if (exists && atom.config.get('remote-ftp.tree.showViewOnStartup')) {
            _this.treeView.attach();
          }
        })['catch'](function (error) {
          var err = error.reason ? error.reason : error.message;

          atom.notifications.addWarning(err);
        });
      }, 0);
    }

    // NOTE: Adds commands to context menus and atom.commands
    (0, _menusMain2['default'])();
  },

  createTreeViewEvents: function createTreeViewEvents() {
    var _this2 = this;

    var coreTreeViewElemDragStart = function coreTreeViewElemDragStart(e) {
      var target = e.target.querySelector('.name');
      var localPaths = {
        fullPath: target.getAttribute('data-path'),
        name: target.getAttribute('data-name')
      };

      e.dataTransfer.setData('localPaths', JSON.stringify(localPaths));
      e.dataTransfer.effectAllowed = 'move';
    };

    var coreTreeViewElemDrop = function coreTreeViewElemDrop(e) {
      var pathInfos = e.dataTransfer.getData('pathInfos');

      if (pathInfos.length > 0) {
        var remotePath = JSON.parse(pathInfos);
        var newPathInfo = e.target.querySelector('span[data-path]').getAttribute('data-path');
        var destPath = _path2['default'].join(newPathInfo, remotePath.name);

        if (Object.keys(remotePath).length === 0) {
          console.warn('Empty ', remotePath);
        }

        _this2.client.downloadTo(remotePath.fullPath, destPath, true, function (err) {
          if (err) {
            console.warn(err);
          }
        });
      }
    };

    this.coreTreeViewEvents = {
      coreTreeViewElemDragStart: coreTreeViewElemDragStart,
      coreTreeViewElemDrop: coreTreeViewElemDrop
    };

    atom.packages.activatePackage('tree-view').then(function (treeView) {
      _this2.coreTreeView = treeView.mainModule.getTreeViewInstance();

      if (typeof _this2.coreTreeView.element === 'undefined') {
        return;
      }

      _this2.coreTreeView.element.addEventListener('dragstart', _this2.coreTreeViewEvents.coreTreeViewElemDragStart);
      _this2.coreTreeView.element.addEventListener('drop', _this2.coreTreeViewEvents.coreTreeViewElemDrop);
    });
  },

  dropTreeViewEvents: function dropTreeViewEvents() {
    if (this.coreTreeView && this.coreTreeView.element && this.coreTreeViewEvents) {
      this.coreTreeView.element.removeEventListener('dragstart', this.coreTreeViewEvents.coreTreeViewElemDragStart);
      this.coreTreeView.element.removeEventListener('drop', this.coreTreeViewEvents.coreTreeViewElemDrop);

      delete this.coreTreeViewEvents;
      this.coreTreeView = null;
    }
  },

  deactivate: function deactivate() {
    this.subscriptions.dispose();
    this.destroyStatusBar();

    if (this.client) this.client.disconnect();
    if (this.treeView) this.treeView.detach();

    this.dropTreeViewEvents();

    this.client = null;
    this.treeView = null;

    delete atom.project.remoteftpMain;
    delete atom.project.remoteftp;
  },

  fileSaved: function fileSaved(text) {
    if (!(0, _helpers.hasProject)()) return;

    if (!this.storage.data.options.autosave) return;
    if (atom.config.get('remote-ftp.connector.autoUploadOnSave') === 'never') return;

    if (!this.client.isConnected() && atom.config.get('remote-ftp.connector.autoUploadOnSave') !== 'always') return;

    var local = text.path;

    if (!atom.project.contains(local)) return;

    // Read config if undefined
    if (!this.client.ftpConfigPath) {
      this.client.readConfig();
    }

    if (this.client.ftpConfigPath !== this.client.getConfigPath()) return;

    // .ftpignore filter
    if (this.client.checkIgnore(local)) return;

    if (local === this.client.getConfigPath()) return;
    // TODO: Add fix for files which are uploaded from a glob selector
    // don't upload files watched, they will be uploaded by the watcher
    // doesn't work fully with new version of watcher
    if (this.client.watch.files.indexOf(local) >= 0) return;

    // get file name for notification message
    var uploadedItem = atom.workspace.getActiveTextEditor().getFileName();

    this.client.upload(local, function (err) {
      if (atom.config.get('remote-ftp.notifications.enableTransfer')) {
        if (err) {
          atom.notifications.addError('Remote FTP: ' + uploadedItem + ' could not upload.');
        } else {
          atom.notifications.addSuccess('Remote FTP: ' + uploadedItem + ' uploaded.');
        }
      }
    });
  },

  serialize: function serialize() {
    return this.storage.data;
  },

  consumeElementIcons: function consumeElementIcons(fn) {
    (0, _helpers.setIconHandler)(fn);
    return new _atom.Disposable(function () {
      (0, _helpers.setIconHandler)(null);
    });
  },

  setStatusbar: function setStatusbar(statusBar) {
    var _this3 = this;

    this.destroyStatusBar(statusBar);

    this.subscriptions.add(atom.config.onDidChange('remote-ftp.statusbar.enable', function () {
      _this3.setStatusbar(statusBar);
    }));

    if (!atom.config.get('remote-ftp.statusbar.enable')) return;

    this.statusBarView = new _viewsStatusBar2['default']();

    var options = {
      item: this.statusBarView,
      priority: atom.config.get('remote-ftp.statusbar.priority')
    };

    if (atom.config.get('remote-ftp.statusbar.position') === 'left') {
      this.statusBarTile = statusBar.addLeftTile(options);
    } else {
      this.statusBarTile = statusBar.addRightTile(options);
    }

    this.subscriptions.add(atom.config.onDidChange('remote-ftp.statusbar.position', function () {
      _this3.setStatusbar(statusBar);
    }), atom.config.onDidChange('remote-ftp.statusbar.priority', function () {
      _this3.setStatusbar(statusBar);
    }));
  },

  destroyStatusBar: function destroyStatusBar() {
    if (this.statusBarTile) {
      this.statusBarTile.destroy();
      this.statusBarTile = null;
    }

    if (this.statusBarView) {
      this.statusBarView.dispose();
      this.statusBarView = null;
    }
  },

  consumeStatusBar: function consumeStatusBar(statusBar) {
    this.setStatusbar(statusBar);
  }

};
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi9ob21lL2ZlbGlwZS8uYXRvbS9wYWNrYWdlcy9yZW1vdGUtZnRwL2xpYi9yZW1vdGUtZnRwLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7OztvQkFFc0QsTUFBTTs7b0JBQzNDLE1BQU07Ozs7c0JBQ0osVUFBVTs7Ozs2QkFDUixtQkFBbUI7Ozs7OEJBQ2Qsb0JBQW9COzs7O3VCQUNILFdBQVc7O3lCQUM3QixjQUFjOzs7O2dDQUNwQixzQkFBc0I7Ozs7NkJBQ2Ysa0JBQWtCOzs7O0FBVjVDLFdBQVcsQ0FBQzs7cUJBWUc7O0FBRWIsUUFBTSwrQkFBQTtBQUNOLFFBQU0sRUFBRSxJQUFJO0FBQ1osY0FBWSxFQUFFLElBQUk7QUFDbEIsVUFBUSxFQUFFLElBQUk7QUFDZCxlQUFhLEVBQUUsSUFBSTtBQUNuQixlQUFhLEVBQUUsSUFBSTtBQUNuQixlQUFhLEVBQUUsSUFBSTs7QUFFbkIsVUFBUSxFQUFBLGtCQUFDLEtBQUssRUFBRTs7O0FBQ2QsUUFBSSxDQUFDLE9BQU8sR0FBRywrQkFBa0IsS0FBSyxDQUFDLENBQUM7O0FBRXhDLFFBQUksSUFBSSxDQUFDLGFBQWEsRUFBRTtBQUN0QixVQUFJLENBQUMsVUFBVSxFQUFFLENBQUM7S0FDbkI7O0FBRUQsUUFBSSxDQUFDLE1BQU0sZ0NBQVMsQ0FBQztBQUNyQixRQUFJLENBQUMsTUFBTSxHQUFHLHlCQUFZLENBQUM7QUFDM0IsUUFBSSxDQUFDLE9BQU8sQ0FBQyxhQUFhLEdBQUcsSUFBSSxDQUFDO0FBQ2xDLFFBQUksQ0FBQyxPQUFPLENBQUMsU0FBUyxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUM7QUFDckMsUUFBSSxDQUFDLFFBQVEsR0FBRywrQkFBYSxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7O0FBRTNDLFFBQUksQ0FBQyxhQUFhLEdBQUcsK0JBQXlCLENBQUM7QUFDL0MsUUFBSSxDQUFDLGFBQWEsQ0FBQyxHQUFHLENBQ3BCLElBQUksQ0FBQyxTQUFTLENBQUMsa0JBQWtCLENBQUMsVUFB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bS9wYWNrYWdlcy9yZW1vdGUtZnRwL2xpYi9yZW1vdGUtZnRwLmpzIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBiYWJlbCc7XG5cbmltcG9ydCB7IEZpbGUsIERpc3Bvc2FibGUsIENvbXBvc2l0ZURpc3Bvc2FibGUgfSBmcm9tICdhdG9tJztcbmltcG9ydCBQYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IENsaWVudCBmcm9tICcuL2NsaWVudCc7XG5pbXBvcnQgVHJlZVZpZXcgZnJvbSAnLi92aWV3cy90cmVlLXZpZXcnO1xuaW1wb3J0IFN0YXR1c0JhclZpZXcgZnJvbSAnLi92aWV3cy9zdGF0dXMtYmFyJztcbmltcG9ydCB7IGhhc1Byb2plY3QsIHNldEljb25IYW5kbGVyIH0gZnJvbSAnLi9oZWxwZXJzJztcbmltcG9ydCBpbml0Q29tbWFuZHMgZnJvbSAnLi9tZW51cy9tYWluJztcbmltcG9ydCBjb25maWcgZnJvbSAnLi9jb25maWctc2NoZW1hLmpzb24nO1xuaW1wb3J0IFJlbW90ZVN0b3JhZ2UgZnJvbSAnLi9yZW1vdGUtc3RvcmFnZSc7XG5cbmV4cG9ydCBkZWZhdWx0IHtcblxuICBjb25maWcsXG4gIGNsaWVudDogbnVsbCxcbiAgY29yZVRyZWVWaWV3OiBudWxsLFxuICB0cmVlVmlldzogbnVsbCxcbiAgc3RhdHVzQmFyVGlsZTogbnVsbCxcbiAgc3RhdHVzQmFyVmlldzogbnVsbCxcbiAgc3Vic2NyaXB0aW9uczogbnVsbCxcblxuICBhY3RpdmF0ZShzdGF0ZSkge1xuICAgIHRoaXMuc3RvcmFnZSA9IG5ldyBSZW1vdGVTdG9yYWdlKHN0YXRlKTtcblxuICAgIGlmICh0aGlzLnN1YnNjcmlwdGlvbnMpIHtcbiAgICAgIHRoaXMuZGVhY3RpdmF0ZSgpO1xuICAgIH1cblxuICAgIHRoaXMuY29uZmlnID0gY29uZmlnO1xuICAgIHRoaXMuY2xpZW50ID0gbmV3IENsaWVudCgpO1xuICAgIGF0b20ucHJvamVjdC5yZW1vdGVmdHBNYWluID0gdGhpczsgLy8gY2hhbmdlIHJlbW90ZWZ0cCB0byBvYmplY3QgY29udGFpbmluZyBjbGllbnQgYW5kIG1haW4/XG4gICAgYXRvbS5wcm9qZWN0LnJlbW90ZWZ0cCA9IHRoaXMuY2xpZW50O1xuICAgIHRoaXMudHJlZVZpZXcgPSBuZXcgVHJlZVZpZXcodGhpcy5zdG9yYWdlKTtcblxuICAgIHRoaXMuc3Vic2NyaXB0aW9ucyA9IG5ldyBDb21wb3NpdGVEaXNwb3NhYmxlKCk7XG4gICAgdGhpcy5zdWJzY3JpcHRpb25zLmFkZChcbiAgICAgIGF0b20ud29ya3NwYWNlLm9ic2VydmVUZXh0RWRpdG9ycygoZWRpdG9yKSA9PiB7XG4gICAgICAgIHRoaXMuc3Vic2NyaXB0aW9ucy5hZGQoXG4gICAgICAgICAgZWRpdG9yLm9uRGlkU2F2ZShldmVudCA9PiB0aGlzLmZpbGVTYXZlZChldmVudCkpLFxuICAgICAgICApO1xuICAgICAgfSksXG5cbiAgICAgIGF0b20ucHJvamVjdC5vbkRpZENoYW5nZVBhdGhzKCgpID0+IHtcbiAgICAgICAgaWYgKCFoYXNQcm9qZWN0KCkgfHwgIXRoaXMuY2xpZW50LmlzQ29ubmVjdGVkKCkpIHJldHVybjtcblxuICAgICAgICBhdG9tLmNvbW1hbmRzLmRpc3BhdGNoKGF0b20udmlld3MuZ2V0VmlldyhhdG9tLndvcmtzcGFjZSksICdyZW1vdGUtZnRwOmRpc2Nvbm5lY3QnKTtcbiAgICAgICAgYXRvbS5jb21tYW5kcy5kaXNwYXRjaChhdG9tLnZpZXdzLmdldFZpZXcoYXRvbS53b3Jrc3BhY2UpLCAncmVtb3RlLWZ0cDpjb25uZWN0Jyk7XG4gICAgICB9KSxcblxuICAgICAgYXRvbS53b3Jrc3BhY2UucGFuZUNvbnRhaW5lcnMubGVmdC5vbkRpZENoYW5nZUFjdGl2ZVBhbmVJdGVtKChhY3RpdmVJdGVtKSA9PiB7XG4gICAgICAgIGlmICh0aGlzLnRyZWVWaWV3ICE9PSBhY3RpdmVJdGVtKSByZXR1cm47XG5cbiAgICAgICAgdGhpcy5zdG9yYWdlLmRhdGEub3B0aW9ucy50cmVlVmlld1NpZGUgPSAnbGVmdCc7XG4gICAgICB9KSxcblxuICAgICAgYXRvbS53b3Jrc3BhY2UucGFuZUNvbnRhaW5lcnMucmlnaHQub25EaWRDaGFuZ2VBY3RpdmVQYW5lSXRlbSgoYWN0aXZlSXRlbSkgPT4ge1xuICAgICAgICBpZiAodGhpcy50cmVlVmlldyAhPT0gYWN0aXZlSXRlbSkgcmV0dXJuO1xuXG4gICAgICAgIHRoaXMuc3RvcmFnZS5kYXRhLm9wdGlvbnMudHJlZVZpZXdTaWRlID0gJ3JpZ2h0JztcbiAgICAgIH0pLFxuXG4gICAgICBhdG9tLndvcmtzcGFjZS5wYW5lQ29udGFpbmVycy5ib3R0b20ub25EaWRDaGFuZ2VBY3RpdmVQYW5lSXRlbSgoYWN0aXZlSXRlbSkgPT4ge1xuICAgICAgICBpZiAodGhpcy50cmVlVmlldyAhPT0gYWN0aXZlSXRlbSkgcmV0dXJuO1xuXG4gICAgICAgIHRoaXMuc3RvcmFnZS5kYXRhLm9wdGlvbnMudHJlZVZpZXdTaWRlID0gJ2JvdHRvbSc7XG4gICAgICB9KSxcblxuICAgICAgYXRvbS5jb25maWcub25EaWRDaGFuZ2UoJ3JlbW90ZS1mdHAudHJlZS5lbmFibGVEcmFnQW5kRHJvcCcsICh2YWx1ZSkgPT4ge1xuICAgICAgICBpZiAodmFsdWUubmV3VmFsdWUpIHtcbiAgICAgICAgICB0aGlzLmNyZWF0ZVRyZWVWaWV3RXZlbnRzKCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgdGhpcy5kcm9wVHJlZVZpZXdFdmVudHMoKTtcbiAgICAgICAgfVxuICAgICAgfSksXG4gICAgKTtcblxuICAgIGlmIChhdG9tLmNvbmZpZy5nZXQoJ3JlbW90ZS1mdHAudHJlZS5lbmFibGVEcmFnQW5kRHJvcCcpKSB7XG4gICAgICB0aGlzLmNyZWF0ZVRyZWVWaWV3RXZlbnRzKCk7XG4gICAgfVxuXG4gICAgdGhpcy5jbGllbnQub25EaWRDb25uZWN0ZWQoKCkgPT4ge1xuICAgICAgdGhpcy50cmVlVmlldy5yb290Lm5hbWUuYXR0cignZGF0YS1uYW1lJywgUGF0aC5iYXNlbmFtZSh0aGlzLmNsaWVudC5yb290LnJlbW90ZSkpO1xuICAgICAgdGhpcy50cmVlVmlldy5yb290Lm5hbWUuYXR0cignZGF0YS1wYXRoJywgdGhpcy5jbGllbnQucm9vdC5yZW1vdGUpO1xuXG4gICAgICAvLyAuZnRwaWdub3JlIGluaXRpYWxpemVcbiAgICAgIHRoaXMuY2xpZW50LnVwZGF0ZUlnbm9yZSgpO1xuICAgIH0pO1xuXG4gICAgLy8gTk9URTogaWYgdGhlcmUgaXMgYSBwcm9qZWN0IGZvbGRlciAmIHNob3cgdmlldyBvbiBzdGFydHVwXG4gICAgLy8gIGlzIHRydWUsIHNob3cgdGhlIFJlbW90ZSBGVFAgc2lkZWJhclxuICAgIGlmIChoYXNQcm9qZWN0KCkpIHtcbiAgICAgIC8vIE5PVEU6IHNldFRpbWVvdXQgaXMgZm9yIHdoZW4gbXVsdGlwbGUgaG9zdHMgb3B0aW9uIGlzIHRydWVcbiAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICBjb25zdCBjb25mID0gbmV3IEZpbGUodGhpcy5jbGllbnQuZ2V0Q29uZmlnUGF0aCgpKTtcblxuICAgICAgICBjb25mLmV4aXN0cygpLnRoZW4oKGV4aXN0cykgPT4ge1xuICAgICAgICAgIGlmIChleGlzdHMgJiYgYXRvbS5jb25maWcuZ2V0KCdyZW1vdGUtZnRwLnRyZWUuc2hvd1ZpZXdPblN0YXJ0dXAnKSkge1xuICAgICAgICAgICAgdGhpcy50cmVlVmlldy5hdHRhY2goKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pLmNhdGNoKChlcnJvcikgPT4ge1xuICAgICAgICAgIGNvbnN0IGVyciA9IChlcnJvci5yZWFzb24pID8gZXJyb3IucmVhc29uIDogZXJyb3IubWVzc2FnZTtcblxuICAgICAgICAgIGF0b20ubm90aWZpY2F0aW9ucy5hZGRXYXJuaW5nKGVycik7XG4gICAgICAgIH0pO1xuICAgICAgfSwgMCk7XG4gICAgfVxuXG4gICAgLy8gTk9URTogQWRkcyBjb21tYW5kcyB0byBjb250ZXh0IG1lbnVzIGFuZCBhdG9tLmNvbW1hbmRzXG4gICAgaW5pdENvbW1hbmRzKCk7XG4gIH0sXG5cbiAgY3JlYXRlVHJlZVZpZXdFdmVudHMoKSB7XG4gICAgY29uc3QgY29yZVRyZWVWaWV3RWxlbURyYWdTdGFydCA9IChlKSA9PiB7XG4gICAgICBjb25zdCB0YXJnZXQgPSBlLnRhcmdldC5xdWVyeVNlbGVjdG9yKCcubmFtZScpO1xuICAgICAgY29uc3QgbG9jYWxQYXRocyA9IHtcbiAgICAgICAgZnVsbFBhdGg6IHRhcmdldC5nZXRBdHRyaWJ1dGUoJ2RhdGEtcGF0aCcpLFxuICAgICAgICBuYW1lOiB0YXJnZXQuZ2V0QXR0cmlidXRlKCdkYXRhLW5hbWUnKSxcbiAgICAgIH07XG5cbiAgICAgIGUuZGF0YVRyYW5zZmVyLnNldERhdGEoJ2xvY2FsUGF0aHMnLCBKU09OLnN0cmluZ2lmeShsb2NhbFBhdGhzKSk7XG4gICAgICBlLmRhdGFUcmFuc2Zlci5lZmZlY3RBbGxvd2VkID0gJ21vdmUnO1xuICAgIH07XG5cbiAgICBjb25zdCBjb3JlVHJlZVZpZXdFbGVtRHJvcCA9IChlKSA9PiB7XG4gICAgICBjb25zdCBwYXRoSW5mb3MgPSBlLmRhdGFUcmFuc2Zlci5nZXREYXRhKCdwYXRoSW5mb3MnKTtcblxuICAgICAgaWYgKHBhdGhJbmZvcy5sZW5ndGggPiAwKSB7XG4gICAgICAgIGNvbnN0IHJlbW90ZVBhdGggPSBKU09OLnBhcnNlKHBhdGhJbmZvcyk7XG4gICAgICAgIGNvbnN0IG5ld1BhdGhJbmZvID0gZS50YXJnZXQucXVlcnlTZWxlY3Rvcignc3BhbltkYXRhLXBhdGhdJykuZ2V0QXR0cmlidXRlKCdkYXRhLXBhdGgnKTtcbiAgICAgICAgY29uc3QgZGVzdFBhdGggPSBQYXRoLmpvaW4obmV3UGF0aEluZm8sIHJlbW90ZVBhdGgubmFtZSk7XG5cbiAgICAgICAgaWYgKE9iamVjdC5rZXlzKHJlbW90ZVBhdGgpLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgIGNvbnNvbGUud2FybignRW1wdHkgJywgcmVtb3RlUGF0aCk7XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLmNsaWVudC5kb3dubG9hZFRvKHJlbW90ZVBhdGguZnVsbFBhdGgsIGRlc3RQYXRoLCB0cnVlLCAoZXJyKSA9PiB7XG4gICAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgICAgY29uc29sZS53YXJuKGVycik7XG4gICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICB9O1xuXG4gICAgdGhpcy5jb3JlVHJlZVZpZXdFdmVudHMgPSB7XG4gICAgICBjb3JlVHJlZVZpZXdFbGVtRHJhZ1N0YXJ0LFxuICAgICAgY29yZVRyZWVWaWV3RWxlbURyb3AsXG4gICAgfTtcblxuICAgIGF0b20ucGFja2FnZXMuYWN0aXZhdGVQYWNrYWdlKCd0cmVlLXZpZXcnKS50aGVuKCh0cmVlVmlldykgPT4ge1xuICAgICAgdGhpcy5jb3JlVHJlZVZpZXcgPSB0cmVlVmlldy5tYWluTW9kdWxlLmdldFRyZWVWaWV3SW5zdGFuY2UoKTtcblxuICAgICAgaWYgKHR5cGVvZiB0aGlzLmNvcmVUcmVlVmlldy5lbGVtZW50ID09PSAndW5kZWZpbmVkJykge1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG5cbiAgICAgIHRoaXMuY29yZVRyZWVWaWV3LmVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignZHJhZ3N0YXJ0JywgdGhpcy5jb3JlVHJlZVZpZXdFdmVudHMuY29yZVRyZWVWaWV3RWxlbURyYWdTdGFydCk7XG4gICAgICB0aGlzLmNvcmVUcmVlVmlldy5lbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ2Ryb3AnLCB0aGlzLmNvcmVUcmVlVmlld0V2ZW50cy5jb3JlVHJlZVZpZXdFbGVtRHJvcCk7XG4gICAgfSk7XG4gIH0sXG5cbiAgZHJvcFRyZWVWaWV3RXZlbnRzKCkge1xuICAgIGlmICh0aGlzLmNvcmVUcmVlVmlldyAmJiB0aGlzLmNvcmVUcmVlVmlldy5lbGVtZW50ICYmIHRoaXMuY29yZVRyZWVWaWV3RXZlbnRzKSB7XG4gICAgICB0aGlzLmNvcmVUcmVlVmlldy5lbGVtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ2RyYWdzdGFydCcsIHRoaXMuY29yZVRyZWVWaWV3RXZlbnRzLmNvcmVUcmVlVmlld0VsZW1EcmFnU3RhcnQpO1xuICAgICAgdGhpcy5jb3JlVHJlZVZpZXcuZWxlbWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCdkcm9wJywgdGhpcy5jb3JlVHJlZVZpZXdFdmVudHMuY29yZVRyZWVWaWV3RWxlbURyb3ApO1xuXG4gICAgICBkZWxldGUgdGhpcy5jb3JlVHJlZVZpZXdFdmVudHM7XG4gICAgICB0aGlzLmNvcmVUcmVlVmlldyA9IG51bGw7XG4gICAgfVxuICB9LFxuXG4gIGRlYWN0aXZhdGUoKSB7XG4gICAgdGhpcy5zdWJzY3JpcHRpb25zLmRpc3Bvc2UoKTtcbiAgICB0aGlzLmRlc3Ryb3lTdGF0dXNCYXIoKTtcblxuICAgIGlmICh0aGlzLmNsaWVudCkgdGhpcy5jbGllbnQuZGlzY29ubmVjdCgpO1xuICAgIGlmICh0aGlzLnRyZWVWaWV3KSB0aGlzLnRyZWVWaWV3LmRldGFjaCgpO1xuXG4gICAgdGhpcy5kcm9wVHJlZVZpZXdFdmVudHMoKTtcblxuICAgIHRoaXMuY2xpZW50ID0gbnVsbDtcbiAgICB0aGlzLnRyZWVWaWV3ID0gbnVsbDtcblxuICAgIGRlbGV0ZSBhdG9tLnByb2plY3QucmVtb3RlZnRwTWFpbjtcbiAgICBkZWxldGUgYXRvbS5wcm9qZWN0LnJlbW90ZWZ0cDtcbiAgfSxcblxuICBmaWxlU2F2ZWQodGV4dCkge1xuICAgIGlmICghaGFzUHJvamVjdCgpKSByZXR1cm47XG5cbiAgICBpZiAoIXRoaXMuc3RvcmFnZS5kYXRhLm9wdGlvbnMuYXV0b3NhdmUpIHJldHVybjtcbiAgICBpZiAoYXRvbS5jb25maWcuZ2V0KCdyZW1vdGUtZnRwLmNvbm5lY3Rvci5hdXRvVXBsb2FkT25TYXZlJykgPT09ICduZXZlcicpIHJldHVybjtcblxuICAgIGlmICghdGhpcy5jbGllbnQuaXNDb25uZWN0ZWQoKSAmJiBhdG9tLmNvbmZpZy5nZXQoJ3JlbW90ZS1mdHAuY29ubmVjdG9yLmF1dG9VcGxvYWRPblNhdmUnKSAhPT0gJ2Fsd2F5cycpIHJldHVybjtcblxuICAgIGNvbnN0IGxvY2FsID0gdGV4dC5wYXRoO1xuXG4gICAgaWYgKCFhdG9tLnByb2plY3QuY29udGFpbnMobG9jYWwpKSByZXR1cm47XG5cbiAgICAvLyBSZWFkIGNvbmZpZyBpZiB1bmRlZmluZWRcbiAgICBpZiAoIXRoaXMuY2xpZW50LmZ0cENvbmZpZ1BhdGgpIHtcbiAgICAgIHRoaXMuY2xpZW50LnJlYWRDb25maWcoKTtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5jbGllbnQuZnRwQ29uZmlnUGF0aCAhPT0gdGhpcy5jbGllbnQuZ2V0Q29uZmlnUGF0aCgpKSByZXR1cm47XG5cbiAgICAvLyAuZnRwaWdub3JlIGZpbHRlclxuICAgIGlmICh0aGlzLmNsaWVudC5jaGVja0lnbm9yZShsb2NhbCkpIHJldHVybjtcblxuICAgIGlmIChsb2NhbCA9PT0gdGhpcy5jbGllbnQuZ2V0Q29uZmlnUGF0aCgpKSByZXR1cm47XG4gICAgLy8gVE9ETzogQWRkIGZpeCBmb3IgZmlsZXMgd2hpY2ggYXJlIHVwbG9hZGVkIGZyb20gYSBnbG9iIHNlbGVjdG9yXG4gICAgLy8gZG9uJ3QgdXBsb2FkIGZpbGVzIHdhdGNoZWQsIHRoZXkgd2lsbCBiZSB1cGxvYWRlZCBieSB0aGUgd2F0Y2hlclxuICAgIC8vIGRvZXNuJ3Qgd29yayBmdWxseSB3aXRoIG5ldyB2ZXJzaW9uIG9mIHdhdGNoZXJcbiAgICBpZiAodGhpcy5jbGllbnQud2F0Y2guZmlsZXMuaW5kZXhPZihsb2NhbCkgPj0gMCkgcmV0dXJuO1xuXG4gICAgLy8gZ2V0IGZpbGUgbmFtZSBmb3Igbm90aWZpY2F0aW9uIG1lc3NhZ2VcbiAgICBjb25zdCB1cGxvYWRlZEl0ZW0gPSBhdG9tLndvcmtzcGFjZS5nZXRBY3RpdmVUZXh0RWRpdG9yKCkuZ2V0RmlsZU5hbWUoKTtcblxuICAgIHRoaXMuY2xpZW50LnVwbG9hZChsb2NhbCwgKGVycikgPT4ge1xuICAgICAgaWYgKGF0b20uY29uZmlnLmdldCgncmVtb3RlLWZ0cC5ub3RpZmljYXRpb25zLmVuYWJsZVRyYW5zZmVyJykpIHtcbiAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgIGF0b20ubm90aWZpY2F0aW9ucy5hZGRFcnJvcihgUmVtb3RlIEZUUDogJHt1cGxvYWRlZEl0ZW19IGNvdWxkIG5vdCB1cGxvYWQuYCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgYXRvbS5ub3RpZmljYXRpb25zLmFkZFN1Y2Nlc3MoYFJlbW90ZSBGVFA6ICR7dXBsb2FkZWRJdGVtfSB1cGxvYWRlZC5gKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0pO1xuICB9LFxuXG4gIHNlcmlhbGl6ZSgpIHtcbiAgICByZXR1cm4gdGhpcy5zdG9yYWdlLmRhdGE7XG4gIH0sXG5cbiAgY29uc3VtZUVsZW1lbnRJY29ucyhmbikge1xuICAgIHNldEljb25IYW5kbGVyKGZuKTtcbiAgICByZXR1cm4gbmV3IERpc3Bvc2FibGUoKCkgPT4ge1xuICAgICAgc2V0SWNvbkhhbmRsZXIobnVsbCk7XG4gICAgfSk7XG4gIH0sXG5cbiAgc2V0U3RhdHVzYmFyKHN0YXR1c0Jhcikge1xuICAgIHRoaXMuZGVzdHJveVN0YXR1c0JhcihzdGF0dXNCYXIpO1xuXG4gICAgdGhpcy5zdWJzY3JpcHRpb25zLmFkZChcbiAgICAgIGF0b20uY29uZmlnLm9uRGlkQ2hhbmdlKCdyZW1vdGUtZnRwLnN0YXR1c2Jhci5lbmFibGUnLCAoKSA9PiB7XG4gICAgICAgIHRoaXMuc2V0U3RhdHVzYmFyKHN0YXR1c0Jhcik7XG4gICAgICB9KSxcbiAgICApO1xuXG4gICAgaWYgKCFhdG9tLmNvbmZpZy5nZXQoJ3JlbW90ZS1mdHAuc3RhdHVzYmFyLmVuYWJsZScpKSByZXR1cm47XG5cbiAgICB0aGlzLnN0YXR1c0JhclZpZXcgPSBuZXcgU3RhdHVzQmFyVmlldygpO1xuXG4gICAgY29uc3Qgb3B0aW9ucyA9IHtcbiAgICAgIGl0ZW06IHRoaXMuc3RhdHVzQmFyVmlldyxcbiAgICAgIHByaW9yaXR5OiBhdG9tLmNvbmZpZy5nZXQoJ3JlbW90ZS1mdHAuc3RhdHVzYmFyLnByaW9yaXR5JyksXG4gICAgfTtcblxuICAgIGlmIChhdG9tLmNvbmZpZy5nZXQoJ3JlbW90ZS1mdHAuc3RhdHVzYmFyLnBvc2l0aW9uJykgPT09ICdsZWZ0Jykge1xuICAgICAgdGhpcy5zdGF0dXNCYXJUaWxlID0gc3RhdHVzQmFyLmFkZExlZnRUaWxlKG9wdGlvbnMpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLnN0YXR1c0JhclRpbGUgPSBzdGF0dXNCYXIuYWRkUmlnaHRUaWxlKG9wdGlvbnMpO1xuICAgIH1cblxuICAgIHRoaXMuc3Vic2NyaXB0aW9ucy5hZGQoXG4gICAgICBhdG9tLmNvbmZpZy5vbkRpZENoYW5nZSgncmVtb3RlLWZ0cC5zdGF0dXNiYXIucG9zaXRpb24nLCAoKSA9PiB7XG4gICAgICAgIHRoaXMuc2V0U3RhdHVzYmFyKHN0YXR1c0Jhcik7XG4gICAgICB9KSxcblxuICAgICAgYXRvbS5jb25maWcub25EaWRDaGFuZ2UoJ3JlbW90ZS1mdHAuc3RhdHVzYmFyLnByaW9yaXR5JywgKCkgPT4ge1xuICAgICAgICB0aGlzLnNldFN0YXR1c2JhcihzdGF0dXNCYXIpO1xuICAgICAgfSksXG4gICAgKTtcbiAgfSxcblxuICBkZXN0cm95U3RhdHVzQmFyKCkge1xuICAgIGlmICh0aGlzLnN0YXR1c0JhclRpbGUpIHtcbiAgICAgIHRoaXMuc3RhdHVzQmFyVGlsZS5kZXN0cm95KCk7XG4gICAgICB0aGlzLnN0YXR1c0JhclRpbGUgPSBudWxsO1xuICAgIH1cblxuICAgIGlmICh0aGlzLnN0YXR1c0JhclZpZXcpIHtcbiAgICAgIHRoaXMuc3RhdHVzQmFyVmlldy5kaXNwb3NlKCk7XG4gICAgICB0aGlzLnN0YXR1c0JhclZpZXcgPSBudWxsO1xuICAgIH1cbiAgfSxcblxuICBjb25zdW1lU3RhdHVzQmFyKHN0YXR1c0Jhcikge1xuICAgIHRoaXMuc2V0U3RhdHVzYmFyKHN0YXR1c0Jhcik7XG4gIH0sXG5cbn07XG4iXX0=